name: Manual Merge Develop to Main

on:
  workflow_dispatch: # Kích hoạt khi nhấn nút "Run workflow"
    inputs:
      target_branch:
        description: "Target branch to merge into"
        required: true
        default: "main"

jobs:
  check-and-merge:
    runs-on: ubuntu-latest
    steps:
      # 1. Clone repository
      - name: 🛠️ Checkout Repository 🛠️
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2. Cấu hình Git
      - name: ⚙️ Configure Git ⚙️
        run: |
          git config user.name "MinhHien39"
          git config user.email "tranminhhien06072001@gmail.com"

      # 3. Kiểm tra xung đột
      - name: 🔍 Check for Merge Conflicts
        id: check-conflict
        run: |
          git fetch origin ${{ github.event.inputs.target_branch }}
          git fetch origin develop
          git checkout ${{ github.event.inputs.target_branch }}
          git merge --no-commit --no-ff develop || echo "::set-output name=conflict::true"
        continue-on-error: true

      # 4. Hiển thị lỗi nếu có conflict
      - name: ❌ Handle Conflict
        if: steps.check-conflict.outputs.conflict == 'true'
        run: |
          echo "❌ Merge conflict detected! Please resolve conflicts manually."
          exit 1

      # 5. Merge develop vào main nếu không có conflict
      - name: ✅ Manual Merge Develop into Main ✅
        if: steps.check-conflict.outputs.conflict != 'true'
        run: |
          git checkout ${{ github.event.inputs.target_branch }}
          git merge develop --no-ff -m "Manual merge from develop to ${{ github.event.inputs.target_branch }}"
          git push origin ${{ github.event.inputs.target_branch }}
