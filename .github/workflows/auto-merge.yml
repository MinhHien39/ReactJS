name: Auto Merge Develop to Main with Manual Trigger

on:
  push:
    branches:
      - develop # Kích hoạt khi có thay đổi trên nhánh develop
  workflow_dispatch: # Cho phép trigger thủ công để merge

jobs:
  check-conflict:
    runs-on: ubuntu-latest
    steps:
      # 1. Clone repository
      - name: 🛠️ Checkout Repository 🛠️
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2. Kiểm tra conflict giữa main và develop
      - name: 🔀 Attempt Merge Main into Develop (Dry Run)
        id: check-merge
        run: |
          git fetch origin
          git checkout main
          git merge --no-commit --no-ff develop || echo "::set-output name=conflict::true"
        continue-on-error: true

      - name: 🔍 Check for Merge Conflicts
        if: steps.check-merge.outputs.conflict == 'true'
        run: |
          echo "❌ Merge conflict detected! Please resolve conflicts manually."
          exit 1

      - name: ✅ No Conflict Detected
        if: success()
        run: echo "✅ No conflict detected. Ready for manual merge."

  manual-merge:
    runs-on: ubuntu-latest
    needs: check-conflict
    steps:
      # 1. Clone repository
      - name: 🛠️ Checkout Repository 🛠️
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2. Cấu hình Git
      - name: ⚙️ Configure Git ⚙️
        env:
          GIT_USER_NAME: ${{ secrets.GIT_USER_NAME }}
          GIT_USER_EMAIL: ${{ secrets.GIT_USER_EMAIL }}
        run: |
          git config user.name "$GIT_USER_NAME"
          git config user.email "$GIT_USER_EMAIL"

      # 3. Merge develop vào main
      - name: ✅ Merge Develop into Main ✅
        run: |
          git checkout main
          git merge develop --no-ff -m "Manual merge from develop to main"
          git push origin main
